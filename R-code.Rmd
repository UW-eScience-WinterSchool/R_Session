<br> 
<center><img src="https://i.imgur.com/hkb7Bq7.png" width="500"></center>


### Prof. José Manuel Magallanes, PhD

* Associate Professor, Departamento de Ciencias Sociales, Pontificia Universidad Católica del Perú, [jmagallanes@pucp.edu.pe](mailto:jmagallanes@pucp.edu.pe)

* Visiting Associate Professor, Evans School of Public Policy and Governance / Senior Data Science Fellow, eScience Institute, University of Washington, [magajm@uw.edu](mailto:magajm@uw.edu)

_____


# Session 2: Introduction to R.

_____

# The data frame in R

## Collecting data:

Let's collect the file we created in Python:

```{r}
# the location
MyFile='https://github.com/UW-eScience-WinterSchool/R_Session/raw/main/demohdimil.RDS'


# if location is website:
MyFile=url(MyFile)

# get the data:
fromPy=readRDS(file = MyFile) # no need for a library
row.names(fromPy)=NULL   # reset indexes from Python.
```

Always check the data types:

```{r}
str(fromPy)  #,width = 70,strict.width='cut'
```


## Querying data frames:

* What is the country with highest HDI?
```{r}
# you could get more than one
fromPy[fromPy$HDI==max(fromPy$HDI),]
```

```{r}
#or
fromPy[fromPy$HDI==max(fromPy$HDI),'Country']
```

You also have:
```{r}
#or
fromPy[which.max(fromPy$HDI),'Country']
```

Alternatively:


```{r}
library(magrittr)
library(dplyr)

fromPy%>%
    filter(HDI==max(HDI))%>%
    select(Country)
```



* What is the authoritarian country with highest HDI?

```{r}

AUTH=fromPy[fromPy$Regime_type %in% 'Authoritarian',]
AUTH[which.max(AUTH$HDI),'Country']
```

Alternatively,
```{r}
fromPy%>%
    filter(Regime_type %in% 'Authoritarian')%>%
    filter(HDI==max(HDI))%>%
    select(Country)
```

## Aggregating data frames:

The average HDI per continent:

```{r}
aggregate(data=fromPy,HDI ~ Regime_type,FUN=mean)
```

```{r}
fromPy%>%
    group_by(Regime_type) %>% 
    summarise(meanHDI = mean(HDI))
```

The median of the democracy components:

```{r}
aggregate(data=fromPy,
          cbind(Electoral_process_and_pluralism,Functioning_of_government,Political_participation,Political_culture,Civil_liberties)~Regime_type,
          FUN=median)

```
Alternatively:
```{r}
aggregate(data=fromPy[,c(2:7)],.~Regime_type,FUN=median)
```

Or:
```{r}
fromPy[,c(2:7)]%>%
    group_by(Regime_type) %>% 
    summarise_all(list(median))
```


## Creating new data:

One column:

```{r}
fromPy$HDIdico=ifelse(fromPy$HDI>
                          median(fromPy$HDI),1,0)
```


## Basic plotting

Let me plot HDI, a numerical variable:
```{r, eval=TRUE}
library(ggplot2)

base=ggplot(data=fromPy)
base + geom_histogram(aes(x=HDI))
```


Or:
```{r}
base + geom_boxplot(aes(y=HDI))
```

Let me plot Regime type, a categorical variable:

```{r}
base + geom_bar(aes(x=Regime_type))
```

Let me see the association between regime type and HDI:
```{r}
base + geom_boxplot(aes(x=Regime_type,y=HDI)) + coord_flip()
```
Let me see the correlation between democracy score and HDI:

```{r}
base + geom_point(aes(x=DemoIndex,y=HDI)) + coord_flip()
```

Let me see all the the correlations:
```{r}
library(ggcorrplot)
#all correlations:
allCorr = cor(fromPy[,c(3:7,12)])
#all p_values
allPvals=cor_pmat(fromPy[,c(3:7,12)])
```

```{r}
ggcorrplot(allCorr,
           p.mat = allPvals,
           type = "lower",
           lab = TRUE,
           insig = "blank",
           tl.cex = 10)
```

The correlation between HDI and Military expenses, while showing Democracy Index regime type:

```{r}
scat= base + geom_point(aes(HDI,
                        mil_expend,
            color=Regime_type))
scat
```

```{r}
choice=c('Peru','United States')
condition=ifelse(fromPy$Country %in% choice,
                 fromPy$Country,
                 '')

scat + geom_text(x=fromPy$HDI,
                 y=fromPy$mil_expend,
                 aes(label=condition))
```
With the help of **ggrepel**:

```{r}
library(ggrepel)

scat + geom_text_repel(x=fromPy$HDI,
                       y=fromPy$mil_expend,
                       aes(label=condition),
                       angle=60,
                       nudge_y = 8)
```



## Clustering via partitioning

Let's find an alternative regime type using an advanced technique.

### Part 1: Preparing data

**a.** Subset the data frame:

```{r}
dfClus=fromPy[,c(3:7)]
```


**b.** Rename the rows:
```{r}
#from
head(dfClus)
```

```{r}
#to
row.names(dfClus)=fromPy$Country
head(dfClus)
```

**c.** Keep only complete data:


```{r}
dfClus=dfClus[complete.cases(dfClus),]
```


**d.** Compute distance matrix:
```{r}
library(cluster)
dfClus_D=cluster::daisy(x=dfClus)
```


### Part 2: Clustering process

### 1. Apply function: you need to indicate the amount of clusters required.

```{r}
set.seed(123)
numberOfClusters=4
res.pam = pam(x=dfClus_D,
              k = numberOfClusters,
              cluster.only = F)
```


### 2. Save clustering results. 

```{r}
fromPy$pam=res.pam$clustering
```

### 3. Verify cluster ordering. 

```{r}
aggregate(data=fromPy[,c(3:7,15)], .~pam,median)
```

Give the right level:
```{r}
fromPy$pam= factor(fromPy$pam,
       level=c(4,3,2,1),
       label=c(1,2,3,4),
       ordered = T)
       
```


### 3. Detect poor results.

```{r}
base=ggplot(data=fromPy,
            aes(x=HDI,
                y=mil_expend,
                color=pam))
scat=base + geom_point()
scat
```


```{r}
# get the evaluations
eval=as.data.frame(res.pam$silinfo$widths)
# get countries poorly clustered
badPAM=eval[eval$sil_width<0,]
badPAM=row.names(badPAM)
```

```{r}
condition=ifelse(fromPy$Country %in% badPAM,
                 fromPy$Country,
                 '')

scat + geom_text_repel(x=fromPy$HDI,
                       y=fromPy$mil_expend,
                       label=condition,
                       angle=60,
                       nudge_y = 8)
```

We should see how the world likes like based on democracy clusters, follow this steps:

a. Download the world map from [here](https://github.com/eScienceUW-WinterSchool-2020/RSession/raw/master/map/world_map.zip).
b. Unzip the file you downloaded in a folder.
c. Upload the unzipped files into [MAPSHAPER](https://mapshaper.org/). No need to uplod the text file.
d. Transform the map into a TOPOJSON format. Save the topojson into your computer.
e. Get a github account. Create a repository and upload the topojson file.
f. Get the download link and use it in the next code.

```{r}
# installed?
#library(sp)
#library(geojsonio)
library(rgdal)

fromGit="https://github.com/eScienceUW-WinterSchool-2020/RSession/raw/master/map/world_map.json" # link desde github


mapWorld <- rgdal::readOGR(fromGit,stringsAsFactors = FALSE)
```


We have the map:

```{r, eval=TRUE}
plot(mapWorld)
```

The plan is to color the countries according to a group, which will result from clustering. 

```{r, eval=TRUE}
# see data in map
head(mapWorld@data)
```

Let's add our data to the map data:

```{r, eval=TRUE}
mapWorldVars=merge(mapWorld, #map first
                   fromPy, 
                   by='ISO3') 
```


Now paint the world (get colors from [here](http://colorbrewer2.org/)):

```{r, eval=TRUE}
# what:
varToPlot=mapWorldVars$pam

#which colors:
library(RColorBrewer)
colorForScale='YlOrRd'
palette = brewer.pal(4, colorForScale)

# plotting:

## base layer - coloring missing data
plot(mapWorld,col='grey',border=0) 

## top layer
plot(mapWorldVars, col = palette[varToPlot],border=F,add=T)


legend('left', legend = c("POOR","BAD","GOOD","TOP"), 
       fill = palette,
       cex = 0.6, 
       bty = "n",
       title="Clusters")
```

## Regression

This may be the easiest functions:

```{r}
# hypothesis 1:

# The more countries expend in armed forces the better HDI 



hypo1=formula(HDI~mil_expend)
regre1=lm(hypo1,data = fromPy)


```

```{r}
summary(regre1)
```

```{r}
library(sjPlot)

plot_models(regre1,vline.color = "grey")
```


```{r}
# hypothesis 2:

# The more countries expend in armed forces and the more democratic, the better HDI 
hypo2=formula(HDI~mil_expend  + DemoIndex)
regre2=lm(hypo2,data = fromPy)
```

```{r}
summary(regre2)
```

```{r}
anova(regre1,regre2)
```
```{r}
library(sjPlot)

plot_models(regre2)
```

